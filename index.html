<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sun Hut - Book Your Tan</title>
    
    <!-- Use more reliable CDN - cdnjs.cloudflare.com -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #FFF7ED 0%, #FFEDD5 100%);
        }
        
        .sun-hut-orange { background-color: #FF6B35; }
        .sun-hut-yellow { background-color: #FFD700; }
        .sun-hut-text-orange { color: #FF6B35; }
        .sun-hut-border-orange { border-color: #FF6B35; }
        
        .tropical-bg {
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(255, 215, 0, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 107, 53, 0.1) 0%, transparent 50%);
        }
        
        .spinner {
            border: 3px solid #FED7AA;
            border-top-color: #FF6B35;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        #loading-status {
            text-align: center;
            padding: 50px 20px;
            font-size: 18px;
            color: #FF6B35;
        }
        
        .error-message {
            background: #fee;
            border: 2px solid #f00;
            padding: 20px;
            margin: 20px;
            border-radius: 8px;
            color: #c00;
        }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #FED7AA; }
        ::-webkit-scrollbar-thumb { background: #FF6B35; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #E55A2B; }
        
        .btn-orange {
            background-color: #FF6B35;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        
        .btn-orange:hover {
            background-color: #E55A2B;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
        }
        
        .btn-yellow {
            background-color: #FFD700;
            color: #1F2937;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        
        .btn-yellow:hover {
            background-color: #FFC700;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #FF6B35;
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }
        
        .time-slot {
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid #E5E7EB;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
        }
        
        .time-slot:hover {
            border-color: #FF6B35;
            background-color: #FFF7ED;
        }
        
        .time-slot.selected {
            border-color: #FF6B35;
            background-color: #FFEDD5;
        }
        
        .time-slot.unavailable {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #F3F4F6;
        }
    </style>
</head>
<body>
    <div id="root">
        <div id="loading-status">
            <div class="spinner"></div>
            <p>Loading Sun Hut Booking System...</p>
            <p style="font-size: 14px; color: #666;">Please wait while we load the application...</p>
        </div>
    </div>

    <script type="text/babel">
        // Wait for all dependencies to load
        (function() {
            const loadingStatus = document.getElementById('loading-status');
            
            // Check if all dependencies loaded
            function checkDependencies() {
                if (typeof React === 'undefined') {
                    loadingStatus.innerHTML = '<div class="error-message"><h2>Error Loading React</h2><p>The React library failed to load. This might be due to network issues or browser extensions blocking scripts.</p><p>Please try:</p><ul style="text-align: left;"><li>Refreshing the page</li><li>Disabling ad blockers</li><li>Checking your internet connection</li></ul></div>';
                    return false;
                }
                if (typeof ReactDOM === 'undefined') {
                    loadingStatus.innerHTML = '<div class="error-message"><h2>Error Loading ReactDOM</h2><p>The ReactDOM library failed to load.</p></div>';
                    return false;
                }
                if (typeof firebase === 'undefined') {
                    loadingStatus.innerHTML = '<div class="error-message"><h2>Error Loading Firebase</h2><p>The Firebase library failed to load.</p></div>';
                    return false;
                }
                return true;
            }
            
            // Retry loading if dependencies fail
            let retryCount = 0;
            const maxRetries = 3;
            
            function initializeApp() {
                if (!checkDependencies()) {
                    if (retryCount < maxRetries) {
                        retryCount++;
                        loadingStatus.innerHTML += `<p>Retrying (${retryCount}/${maxRetries})...</p>`;
                        setTimeout(initializeApp, 2000);
                    }
                    return;
                }
                
                // All dependencies loaded successfully
                startApp();
            }
            
            function startApp() {
                const { useState, useEffect } = React;

                // Firebase Configuration
                const firebaseConfig = {
                    apiKey: "AIzaSyCRiybLgwke4e38h72ElcvD5Fo_uS3eyQM",
                    authDomain: "tanningsalon-b67a2.firebaseapp.com",
                    projectId: "tanningsalon-b67a2",
                    storageBucket: "tanningsalon-b67a2.firebasestorage.app",
                    messagingSenderId: "407378831723",
                    appId: "1:407378831723:web:2642c751f4c7c90b37042e"
                };

                // Initialize Firebase
                try {
                    if (!firebase.apps.length) {
                        firebase.initializeApp(firebaseConfig);
                    }
                } catch (error) {
                    console.error('Firebase initialization error:', error);
                    loadingStatus.innerHTML = '<div class="error-message"><h2>Firebase Initialization Error</h2><p>' + error.message + '</p></div>';
                    return;
                }
                
                const db = firebase.firestore();
                const auth = firebase.auth();

                // Main App Component
                function BookingWidget() {
                    const [user, setUser] = useState(null);
                    const [loading, setLoading] = useState(true);
                    const [view, setView] = useState('login');
                    const [resources, setResources] = useState([]);
                    const [services, setServices] = useState([]);
                    const [appointments, setAppointments] = useState([]);
                    const [clients, setClients] = useState([]);

                    useEffect(() => {
                        const unsubscribe = auth.onAuthStateChanged(async (authUser) => {
                            if (authUser) {
                                if (authUser.emailVerified) {
                                    setUser(authUser);
                                    setView('booking');
                                    await loadData();
                                } else {
                                    setUser(authUser);
                                    setView('verifyEmail');
                                }
                            } else {
                                setUser(null);
                                setView('login');
                            }
                            setLoading(false);
                        });

                        return () => unsubscribe();
                    }, []);

                    const loadData = async () => {
                        try {
                            const [resourcesSnap, servicesSnap, appointmentsSnap, clientsSnap] = await Promise.all([
                                db.collection('resources').get(),
                                db.collection('services').get(),
                                db.collection('appointments').get(),
                                db.collection('clients').get()
                            ]);

                            setResources(resourcesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                            setServices(servicesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                            setAppointments(appointmentsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                            setClients(clientsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                        } catch (error) {
                            console.error('Error loading data:', error);
                            alert('Error loading data. Please refresh the page.');
                        }
                    };

                    if (loading) {
                        return (
                            <div style={{display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '100vh'}}>
                                <div className="spinner"></div>
                            </div>
                        );
                    }

                    return (
                        <div className="tropical-bg" style={{minHeight: '100vh', padding: '32px 0'}}>
                            {view === 'login' && <LoginForm setView={setView} auth={auth} />}
                            {view === 'register' && <RegisterForm setView={setView} auth={auth} db={db} />}
                            {view === 'verifyEmail' && <VerifyEmail user={user} setView={setView} auth={auth} />}
                            {view === 'booking' && (
                                <BookingForm 
                                    user={user} 
                                    resources={resources} 
                                    services={services} 
                                    appointments={appointments}
                                    clients={clients}
                                    setView={setView}
                                    onUpdate={loadData}
                                    db={db}
                                />
                            )}
                            {view === 'myAppointments' && (
                                <MyAppointments 
                                    appointments={appointments}
                                    resources={resources}
                                    services={services}
                                    user={user}
                                    clients={clients}
                                    onUpdate={loadData}
                                    db={db}
                                />
                            )}

                            {user && view !== 'verifyEmail' && (
                                <div style={{position: 'fixed', bottom: '16px', right: '16px', display: 'flex', gap: '8px'}}>
                                    <button
                                        onClick={() => setView(view === 'booking' ? 'myAppointments' : 'booking')}
                                        className="btn-yellow"
                                        style={{padding: '12px 24px', borderRadius: '8px', fontWeight: 'bold', boxShadow: '0 4px 6px rgba(0,0,0,0.1)'}}
                                    >
                                        {view === 'booking' ? '📅 My Appointments' : '🏠 Book New'}
                                    </button>
                                    <button
                                        onClick={() => auth.signOut()}
                                        style={{padding: '12px 24px', borderRadius: '8px', fontWeight: 'bold', boxShadow: '0 4px 6px rgba(0,0,0,0.1)', backgroundColor: '#4B5563', color: 'white', border: 'none', cursor: 'pointer'}}
                                    >
                                        🚪 Logout
                                    </button>
                                </div>
                            )}
                        </div>
                    );
                }

                function LoginForm({ setView, auth }) {
                    const [email, setEmail] = useState('');
                    const [password, setPassword] = useState('');
                    const [loading, setLoading] = useState(false);
                    const [error, setError] = useState('');

                    const handleLogin = async (e) => {
                        e.preventDefault();
                        setError('');
                        setLoading(true);

                        try {
                            await auth.signInWithEmailAndPassword(email, password);
                        } catch (error) {
                            setError(error.message);
                        }
                        setLoading(false);
                    };

                    return (
                        <div style={{maxWidth: '448px', margin: '0 auto', padding: '0 16px'}}>
                            <div className="card" style={{padding: '32px'}}>
                                <div style={{textAlign: 'center', marginBottom: '32px'}}>
                                    <h1 className="sun-hut-text-orange" style={{fontSize: '36px', fontWeight: 'bold', marginBottom: '8px'}}>☀️ Sun Hut</h1>
                                    <p style={{color: '#6B7280'}}>Book Your Perfect Tan</p>
                                </div>

                                <form onSubmit={handleLogin} style={{display: 'flex', flexDirection: 'column', gap: '16px'}}>
                                    <div>
                                        <label style={{display: 'block', fontSize: '14px', fontWeight: '600', marginBottom: '8px'}}>Email</label>
                                        <input
                                            type="email"
                                            value={email}
                                            onChange={(e) => setEmail(e.target.value)}
                                            style={{width: '100%', padding: '12px 16px', border: '2px solid #D1D5DB', borderRadius: '8px', fontSize: '16px'}}
                                            required
                                        />
                                    </div>

                                    <div>
                                        <label style={{display: 'block', fontSize: '14px', fontWeight: '600', marginBottom: '8px'}}>Password</label>
                                        <input
                                            type="password"
                                            value={password}
                                            onChange={(e) => setPassword(e.target.value)}
                                            style={{width: '100%', padding: '12px 16px', border: '2px solid #D1D5DB', borderRadius: '8px', fontSize: '16px'}}
                                            required
                                        />
                                    </div>

                                    {error && (
                                        <div style={{backgroundColor: '#FEE2E2', border: '1px solid #FCA5A5', color: '#991B1B', padding: '12px 16px', borderRadius: '8px'}}>
                                            {error}
                                        </div>
                                    )}

                                    <button
                                        type="submit"
                                        disabled={loading}
                                        className="btn-orange"
                                        style={{width: '100%', color: 'white', padding: '12px 24px', borderRadius: '8px', fontWeight: 'bold', fontSize: '18px'}}
                                    >
                                        {loading ? 'Logging in...' : '🔓 Login'}
                                    </button>
                                </form>

                                <div style={{marginTop: '24px', textAlign: 'center'}}>
                                    <p style={{color: '#6B7280'}}>
                                        Don't have an account?{' '}
                                        <button
                                            onClick={() => setView('register')}
                                            className="sun-hut-text-orange"
                                            style={{fontWeight: 'bold', background: 'none', border: 'none', cursor: 'pointer', textDecoration: 'underline'}}
                                        >
                                            Register here
                                        </button>
                                    </p>
                                </div>
                            </div>
                        </div>
                    );
                }

                function RegisterForm({ setView, auth, db }) {
                    const [formData, setFormData] = useState({
                        firstName: '',
                        lastName: '',
                        email: '',
                        phone: '',
                        password: '',
                        confirmPassword: ''
                    });
                    const [loading, setLoading] = useState(false);
                    const [error, setError] = useState('');

                    const handleRegister = async (e) => {
                        e.preventDefault();
                        setError('');

                        if (formData.password !== formData.confirmPassword) {
                            setError('Passwords do not match');
                            return;
                        }

                        if (formData.password.length < 6) {
                            setError('Password must be at least 6 characters');
                            return;
                        }

                        setLoading(true);

                        try {
                            const userCredential = await auth.createUserWithEmailAndPassword(
                                formData.email,
                                formData.password
                            );

                            await userCredential.user.sendEmailVerification();

                            const clientsSnapshot = await db.collection('clients').get();
                            const maxId = clientsSnapshot.docs.reduce((max, doc) => {
                                const id = parseInt(doc.data().id) || 0;
                                return id > max ? id : max;
                            }, 0);
                            const newClientId = maxId + 1;

                            await db.collection('clients').doc(newClientId.toString()).set({
                                id: newClientId,
                                firstName: formData.firstName,
                                lastName: formData.lastName,
                                email: formData.email,
                                phone: formData.phone,
                                firebaseUid: userCredential.user.uid,
                                createdAt: new Date().toISOString(),
                                courses: [],
                                redFlag: false,
                                notes: ''
                            });

                            alert('Registration successful! Please check your email to verify your account.');
                            setView('login');
                        } catch (error) {
                            setError(error.message);
                        }
                        setLoading(false);
                    };

                    return (
                        <div style={{maxWidth: '448px', margin: '0 auto', padding: '0 16px'}}>
                            <div className="card" style={{padding: '32px'}}>
                                <div style={{textAlign: 'center', marginBottom: '32px'}}>
                                    <h1 className="sun-hut-text-orange" style={{fontSize: '36px', fontWeight: 'bold', marginBottom: '8px'}}>☀️ Create Account</h1>
                                    <p style={{color: '#6B7280'}}>Join Sun Hut Today</p>
                                </div>

                                <form onSubmit={handleRegister} style={{display: 'flex', flexDirection: 'column', gap: '16px'}}>
                                    <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px'}}>
                                        <div>
                                            <label style={{display: 'block', fontSize: '14px', fontWeight: '600', marginBottom: '8px'}}>First Name</label>
                                            <input
                                                type="text"
                                                value={formData.firstName}
                                                onChange={(e) => setFormData({...formData, firstName: e.target.value})}
                                                style={{width: '100%', padding: '12px 16px', border: '2px solid #D1D5DB', borderRadius: '8px'}}
                                                required
                                            />
                                        </div>
                                        <div>
                                            <label style={{display: 'block', fontSize: '14px', fontWeight: '600', marginBottom: '8px'}}>Last Name</label>
                                            <input
                                                type="text"
                                                value={formData.lastName}
                                                onChange={(e) => setFormData({...formData, lastName: e.target.value})}
                                                style={{width: '100%', padding: '12px 16px', border: '2px solid #D1D5DB', borderRadius: '8px'}}
                                                required
                                            />
                                        </div>
                                    </div>

                                    <div>
                                        <label style={{display: 'block', fontSize: '14px', fontWeight: '600', marginBottom: '8px'}}>Email</label>
                                        <input
                                            type="email"
                                            value={formData.email}
                                            onChange={(e) => setFormData({...formData, email: e.target.value})}
                                            style={{width: '100%', padding: '12px 16px', border: '2px solid #D1D5DB', borderRadius: '8px'}}
                                            required
                                        />
                                    </div>

                                    <div>
                                        <label style={{display: 'block', fontSize: '14px', fontWeight: '600', marginBottom: '8px'}}>Phone</label>
                                        <input
                                            type="tel"
                                            value={formData.phone}
                                            onChange={(e) => setFormData({...formData, phone: e.target.value})}
                                            style={{width: '100%', padding: '12px 16px', border: '2px solid #D1D5DB', borderRadius: '8px'}}
                                            required
                                        />
                                    </div>

                                    <div>
                                        <label style={{display: 'block', fontSize: '14px', fontWeight: '600', marginBottom: '8px'}}>Password</label>
                                        <input
                                            type="password"
                                            value={formData.password}
                                            onChange={(e) => setFormData({...formData, password: e.target.value})}
                                            style={{width: '100%', padding: '12px 16px', border: '2px solid #D1D5DB', borderRadius: '8px'}}
                                            required
                                        />
                                    </div>

                                    <div>
                                        <label style={{display: 'block', fontSize: '14px', fontWeight: '600', marginBottom: '8px'}}>Confirm Password</label>
                                        <input
                                            type="password"
                                            value={formData.confirmPassword}
                                            onChange={(e) => setFormData({...formData, confirmPassword: e.target.value})}
                                            style={{width: '100%', padding: '12px 16px', border: '2px solid #D1D5DB', borderRadius: '8px'}}
                                            required
                                        />
                                    </div>

                                    {error && (
                                        <div style={{backgroundColor: '#FEE2E2', border: '1px solid #FCA5A5', color: '#991B1B', padding: '12px 16px', borderRadius: '8px'}}>
                                            {error}
                                        </div>
                                    )}

                                    <button
                                        type="submit"
                                        disabled={loading}
                                        className="btn-orange"
                                        style={{width: '100%', color: 'white', padding: '12px 24px', borderRadius: '8px', fontWeight: 'bold', fontSize: '18px'}}
                                    >
                                        {loading ? 'Creating Account...' : '✨ Register'}
                                    </button>
                                </form>

                                <div style={{marginTop: '24px', textAlign: 'center'}}>
                                    <p style={{color: '#6B7280'}}>
                                        Already have an account?{' '}
                                        <button
                                            onClick={() => setView('login')}
                                            className="sun-hut-text-orange"
                                            style={{fontWeight: 'bold', background: 'none', border: 'none', cursor: 'pointer', textDecoration: 'underline'}}
                                        >
                                            Login here
                                        </button>
                                    </p>
                                </div>
                            </div>
                        </div>
                    );
                }

                function VerifyEmail({ user, setView, auth }) {
                    const [loading, setLoading] = useState(false);

                    const handleResendEmail = async () => {
                        setLoading(true);
                        try {
                            await user.sendEmailVerification();
                            alert('Verification email sent! Please check your inbox.');
                        } catch (error) {
                            alert('Error sending email: ' + error.message);
                        }
                        setLoading(false);
                    };

                    const handleCheckVerification = async () => {
                        setLoading(true);
                        await user.reload();
                        if (user.emailVerified) {
                            window.location.reload();
                        } else {
                            alert('Email not verified yet. Please check your inbox and click the verification link.');
                        }
                        setLoading(false);
                    };

                    return (
                        <div style={{maxWidth: '448px', margin: '0 auto', padding: '0 16px'}}>
                            <div className="card" style={{padding: '32px'}}>
                                <div style={{textAlign: 'center', marginBottom: '32px'}}>
                                    <div style={{fontSize: '60px', marginBottom: '16px'}}>📧</div>
                                    <h1 className="sun-hut-text-orange" style={{fontSize: '28px', fontWeight: 'bold', marginBottom: '8px'}}>Verify Your Email</h1>
                                    <p style={{color: '#6B7280'}}>
                                        We've sent a verification email to:<br />
                                        <strong>{user.email}</strong>
                                    </p>
                                </div>

                                <div style={{display: 'flex', flexDirection: 'column', gap: '16px'}}>
                                    <p style={{textAlign: 'center', color: '#6B7280'}}>
                                        Please check your inbox and click the verification link to activate your account.
                                    </p>

                                    <button
                                        onClick={handleCheckVerification}
                                        disabled={loading}
                                        className="btn-orange"
                                        style={{width: '100%', color: 'white', padding: '12px 24px', borderRadius: '8px', fontWeight: 'bold'}}
                                    >
                                        {loading ? 'Checking...' : '✅ I\'ve Verified My Email'}
                                    </button>

                                    <button
                                        onClick={handleResendEmail}
                                        disabled={loading}
                                        className="btn-yellow"
                                        style={{width: '100%', padding: '12px 24px', borderRadius: '8px', fontWeight: 'bold'}}
                                    >
                                        {loading ? 'Sending...' : '📨 Resend Verification Email'}
                                    </button>

                                    <button
                                        onClick={() => auth.signOut()}
                                        style={{width: '100%', padding: '12px 24px', borderRadius: '8px', fontWeight: 'bold', backgroundColor: '#E5E7EB', color: '#374151', border: 'none', cursor: 'pointer'}}
                                    >
                                        🚪 Logout
                                    </button>
                                </div>
                            </div>
                        </div>
                    );
                }

                // I need to continue with BookingForm and MyAppointments components
                // Due to length, I'll create a continuation...
                
                function BookingForm({ user, resources, services, appointments, clients, setView, onUpdate, db }) {
                    const [selectedResource, setSelectedResource] = useState(null);
                    const [selectedService, setSelectedService] = useState(null);
                    const [selectedDate, setSelectedDate] = useState('');
                    const [selectedTime, setSelectedTime] = useState('');
                    const [notes, setNotes] = useState('');
                    const [loading, setLoading] = useState(false);

                    const client = clients.find(c => c.firebaseUid === user.uid);
                    const activeResources = resources.filter(r => r.isActive);
                    const activeServices = services.filter(s => s.isActive);

                    const today = new Date().toISOString().split('T')[0];
                    const maxDate = new Date();
                    maxDate.setDate(maxDate.getDate() + 30);
                    const maxDateStr = maxDate.toISOString().split('T')[0];

                    const generateTimeSlots = () => {
                        const slots = [];
                        for (let hour = 9; hour <= 20; hour++) {
                            for (let minute = 0; minute < 60; minute += 30) {
                                const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                                slots.push(timeStr);
                            }
                        }
                        return slots;
                    };

                    const isTimeSlotAvailable = (time) => {
                        if (!selectedResource || !selectedService || !selectedDate) return false;

                        const [hours, minutes] = time.split(':').map(Number);
                        const slotStart = new Date(selectedDate + 'T' + time);
                        const slotEnd = new Date(slotStart.getTime() + selectedService.duration * 60000);

                        const resourceAppointments = appointments.filter(
                            apt => apt.resourceId === selectedResource.id && 
                                   apt.date === selectedDate &&
                                   apt.status !== 'cancelled'
                        );

                        for (const apt of resourceAppointments) {
                            const aptStart = new Date(apt.date + 'T' + apt.startTime);
                            const aptEnd = new Date(apt.date + 'T' + apt.endTime);

                            if (
                                (slotStart >= aptStart && slotStart < aptEnd) ||
                                (slotEnd > aptStart && slotEnd <= aptEnd) ||
                                (slotStart <= aptStart && slotEnd >= aptEnd)
                            ) {
                                return false;
                            }
                        }

                        return true;
                    };

                    const calculateEndTime = (startTime, duration) => {
                        const [hours, minutes] = startTime.split(':').map(Number);
                        const totalMinutes = hours * 60 + minutes + duration;
                        const endHours = Math.floor(totalMinutes / 60);
                        const endMinutes = totalMinutes % 60;
                        return `${endHours.toString().padStart(2, '0')}:${endMinutes.toString().padStart(2, '0')}`;
                    };

                    const handleBooking = async () => {
                        if (!selectedResource || !selectedService || !selectedDate || !selectedTime) {
                            alert('Please complete all booking steps');
                            return;
                        }

                        setLoading(true);

                        try {
                            const appointmentsSnapshot = await db.collection('appointments').get();
                            const maxId = appointmentsSnapshot.docs.reduce((max, doc) => {
                                const id = parseInt(doc.data().id) || 0;
                                return id > max ? id : max;
                            }, 0);
                            const newAppointmentId = maxId + 1;

                            const endTime = calculateEndTime(selectedTime, selectedService.duration);

                            const appointmentData = {
                                id: newAppointmentId,
                                clientId: client.id,
                                resourceId: selectedResource.id,
                                service: selectedService.name,
                                date: selectedDate,
                                startTime: selectedTime,
                                endTime: endTime,
                                duration: selectedService.duration,
                                status: 'confirmed',
                                notes: notes,
                                createdAt: new Date().toISOString(),
                                createdBy: user.email
                            };

                            await db.collection('appointments').doc(newAppointmentId.toString()).set(appointmentData);

                            alert('🎉 Booking confirmed! See you soon!');
                            
                            setSelectedResource(null);
                            setSelectedService(null);
                            setSelectedDate('');
                            setSelectedTime('');
                            setNotes('');
                            
                            await onUpdate();
                        } catch (error) {
                            alert('Error creating booking: ' + error.message);
                        }
                        setLoading(false);
                    };

                    return (
                        <div style={{maxWidth: '896px', margin: '0 auto', padding: '0 16px'}}>
                            <div className="card" style={{padding: '32px'}}>
                                <div style={{textAlign: 'center', marginBottom: '32px'}}>
                                    <h2 className="sun-hut-text-orange" style={{fontSize: '36px', fontWeight: 'bold', marginBottom: '8px'}}>☀️ Book Your Tan</h2>
                                    <p style={{color: '#6B7280'}}>Welcome, {client?.firstName || user.email}!</p>
                                </div>

                                <div style={{display: 'flex', flexDirection: 'column', gap: '32px'}}>
                                    <div>
                                        <h3 style={{fontSize: '20px', fontWeight: 'bold', marginBottom: '16px'}}>1. Choose Your Tanning Bed</h3>
                                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '16px'}}>
                                            {activeResources.map(resource => (
                                                <div
                                                    key={resource.id}
                                                    onClick={() => setSelectedResource(resource)}
                                                    className="card"
                                                    style={{
                                                        padding: '24px',
                                                        cursor: 'pointer',
                                                        border: selectedResource?.id === resource.id ? '2px solid #FF6B35' : '2px solid transparent'
                                                    }}
                                                >
                                                    <div style={{display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '12px'}}>
                                                        <span style={{fontSize: '28px'}}>🛏️</span>
                                                        <h4 style={{fontWeight: 'bold', fontSize: '18px'}}>{resource.name}</h4>
                                                    </div>
                                                    {resource.description && (
                                                        <p style={{color: '#6B7280', fontSize: '14px'}}>{resource.description}</p>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {selectedResource && (
                                        <div>
                                            <h3 style={{fontSize: '20px', fontWeight: 'bold', marginBottom: '16px'}}>2. Select Service</h3>
                                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '16px'}}>
                                                {activeServices.map(service => (
                                                    <div
                                                        key={service.id}
                                                        onClick={() => setSelectedService(service)}
                                                        className="card"
                                                        style={{
                                                            padding: '24px',
                                                            cursor: 'pointer',
                                                            border: selectedService?.id === service.id ? '2px solid #FF6B35' : '2px solid transparent'
                                                        }}
                                                    >
                                                        <h4 style={{fontWeight: 'bold', fontSize: '18px', marginBottom: '8px'}}>{service.name}</h4>
                                                        <p style={{color: '#6B7280', marginBottom: '8px'}}>{service.duration} minutes</p>
                                                        <p className="sun-hut-text-orange" style={{fontSize: '24px', fontWeight: 'bold'}}>FREE</p>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    {selectedService && (
                                        <div>
                                            <h3 style={{fontSize: '20px', fontWeight: 'bold', marginBottom: '16px'}}>3. Pick a Date</h3>
                                            <input
                                                type="date"
                                                value={selectedDate}
                                                onChange={(e) => {
                                                    setSelectedDate(e.target.value);
                                                    setSelectedTime('');
                                                }}
                                                min={today}
                                                max={maxDateStr}
                                                style={{width: '100%', padding: '12px 16px', border: '2px solid #D1D5DB', borderRadius: '8px', fontSize: '18px'}}
                                            />
                                        </div>
                                    )}

                                    {selectedDate && (
                                        <div>
                                            <h3 style={{fontSize: '20px', fontWeight: 'bold', marginBottom: '16px'}}>4. Choose a Time</h3>
                                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(100px, 1fr))', gap: '12px'}}>
                                                {generateTimeSlots().map(time => {
                                                    const available = isTimeSlotAvailable(time);
                                                    return (
                                                        <div
                                                            key={time}
                                                            onClick={() => available && setSelectedTime(time)}
                                                            className={`time-slot ${selectedTime === time ? 'selected' : ''} ${!available ? 'unavailable' : ''}`}
                                                        >
                                                            {time}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    )}

                                    {selectedTime && (
                                        <div>
                                            <h3 style={{fontSize: '20px', fontWeight: 'bold', marginBottom: '16px'}}>5. Additional Notes (Optional)</h3>
                                            <textarea
                                                value={notes}
                                                onChange={(e) => setNotes(e.target.value)}
                                                style={{width: '100%', padding: '12px 16px', border: '2px solid #D1D5DB', borderRadius: '8px'}}
                                                rows="3"
                                                placeholder="Any special requests or notes..."
                                            />
                                        </div>
                                    )}

                                    {selectedTime && (
                                        <div style={{backgroundColor: '#FFF7ED', border: '2px solid #FF6B35', borderRadius: '8px', padding: '24px'}}>
                                            <h3 style={{fontSize: '20px', fontWeight: 'bold', marginBottom: '16px'}}>Booking Summary</h3>
                                            <div style={{marginBottom: '24px', display: 'flex', flexDirection: 'column', gap: '8px'}}>
                                                <p><strong>Date:</strong> {selectedDate}</p>
                                                <p><strong>Tanning Bed:</strong> {selectedResource.name}</p>
                                                <p><strong>Service:</strong> {selectedService.name} ({selectedService.duration} mins)</p>
                                                <p><strong>Time:</strong> {selectedTime}</p>
                                                <p className="sun-hut-text-orange" style={{fontSize: '24px', fontWeight: 'bold'}}>Price: FREE</p>
                                            </div>
                                            
                                            <button
                                                onClick={handleBooking}
                                                disabled={loading}
                                                className="btn-orange"
                                                style={{width: '100%', color: 'white', padding: '16px 24px', borderRadius: '8px', fontWeight: 'bold', fontSize: '20px'}}
                                            >
                                                {loading ? 'Booking...' : '🎉 Confirm Booking'}
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    );
                }

                function MyAppointments({ appointments, resources, services, user, clients, onUpdate, db }) {
                    const [loading, setLoading] = useState(false);

                    const client = clients.find(c => c.firebaseUid === user.uid);
                    
                    const myAppointments = appointments
                        .filter(apt => apt.clientId === client?.id)
                        .sort((a, b) => {
                            const dateA = new Date(a.date + 'T' + a.startTime);
                            const dateB = new Date(b.date + 'T' + b.startTime);
                            return dateB - dateA;
                        });

                    const upcomingAppointments = myAppointments.filter(apt => {
                        const aptDate = new Date(apt.date + 'T' + apt.startTime);
                        return aptDate >= new Date();
                    });

                    const pastAppointments = myAppointments.filter(apt => {
                        const aptDate = new Date(apt.date + 'T' + apt.startTime);
                        return aptDate < new Date();
                    });

                    const handleCancelAppointment = async (appointmentId) => {
                        if (!confirm('Are you sure you want to cancel this appointment?')) {
                            return;
                        }

                        setLoading(true);
                        try {
                            await db.collection('appointments').doc(appointmentId.toString()).delete();
                            alert('Appointment cancelled successfully!');
                            await onUpdate();
                        } catch (error) {
                            alert('Error cancelling appointment: ' + error.message);
                        }
                        setLoading(false);
                    };

                    const AppointmentCard = ({ appointment, isPast }) => {
                        const resource = resources.find(r => r.id === appointment.resourceId);
                        
                        return (
                            <div className="card" style={{padding: '24px', marginBottom: '16px'}}>
                                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start'}}>
                                    <div style={{flex: 1}}>
                                        <div style={{display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '8px'}}>
                                            <span style={{fontSize: '24px'}}>🛏️</span>
                                            <h4 style={{fontWeight: 'bold', fontSize: '20px'}}>{resource?.name || 'Unknown Bed'}</h4>
                                        </div>
                                        
                                        <div style={{color: '#6B7280', display: 'flex', flexDirection: 'column', gap: '4px'}}>
                                            <p><strong>Service:</strong> {appointment.service}</p>
                                            <p><strong>Date:</strong> {appointment.date}</p>
                                            <p><strong>Time:</strong> {appointment.startTime} - {appointment.endTime}</p>
                                            <p><strong>Duration:</strong> {appointment.duration} minutes</p>
                                            {appointment.notes && (
                                                <p><strong>Notes:</strong> {appointment.notes}</p>
                                            )}
                                        </div>
                                        
                                        <div style={{marginTop: '12px'}}>
                                            <span style={{
                                                display: 'inline-block',
                                                padding: '4px 12px',
                                                borderRadius: '9999px',
                                                fontSize: '14px',
                                                fontWeight: '600',
                                                backgroundColor: appointment.status === 'confirmed' ? '#D1FAE5' : appointment.status === 'completed' ? '#DBEAFE' : '#F3F4F6',
                                                color: appointment.status === 'confirmed' ? '#065F46' : appointment.status === 'completed' ? '#1E40AF' : '#374151'
                                            }}>
                                                {appointment.status.charAt(0).toUpperCase() + appointment.status.slice(1)}
                                            </span>
                                        </div>
                                    </div>
                                    
                                    {!isPast && (
                                        <button
                                            onClick={() => handleCancelAppointment(appointment.id)}
                                            disabled={loading}
                                            style={{
                                                marginLeft: '16px',
                                                padding: '8px 16px',
                                                backgroundColor: '#DC2626',
                                                color: 'white',
                                                borderRadius: '8px',
                                                fontWeight: '600',
                                                border: 'none',
                                                cursor: 'pointer'
                                            }}
                                        >
                                            Cancel
                                        </button>
                                    )}
                                </div>
                            </div>
                        );
                    };

                    return (
                        <div style={{maxWidth: '896px', margin: '0 auto', padding: '0 16px'}}>
                            <div className="card" style={{padding: '32px'}}>
                                <h2 className="sun-hut-text-orange" style={{fontSize: '32px', fontWeight: 'bold', marginBottom: '24px', textAlign: 'center'}}>
                                    My Appointments 📅
                                </h2>

                                <div style={{marginBottom: '32px'}}>
                                    <h3 style={{fontSize: '24px', fontWeight: 'bold', marginBottom: '16px'}}>Upcoming Appointments</h3>
                                    {upcomingAppointments.length === 0 ? (
                                        <div style={{textAlign: 'center', padding: '32px 0', backgroundColor: '#F9FAFB', borderRadius: '8px'}}>
                                            <p style={{color: '#6B7280', fontSize: '18px', marginBottom: '16px'}}>No upcoming appointments</p>
                                            <p style={{color: '#9CA3AF'}}>Book your next tan now!</p>
                                        </div>
                                    ) : (
                                        upcomingAppointments.map(apt => (
                                            <AppointmentCard key={apt.id} appointment={apt} isPast={false} />
                                        ))
                                    )}
                                </div>

                                {pastAppointments.length > 0 && (
                                    <div>
                                        <h3 style={{fontSize: '24px', fontWeight: 'bold', marginBottom: '16px'}}>Past Appointments</h3>
                                        {pastAppointments.slice(0, 5).map(apt => (
                                            <AppointmentCard key={apt.id} appointment={apt} isPast={true} />
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    );
                }

                // Render the app
                try {
                    ReactDOM.render(<BookingWidget />, document.getElementById('root'));
                    console.log('App initialized successfully!');
                } catch (error) {
                    console.error('Error rendering app:', error);
                    document.getElementById('root').innerHTML = '<div class="error-message"><h2>Rendering Error</h2><p>' + error.message + '</p></div>';
                }
            }
            
            // Initialize when page loads
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeApp);
            } else {
                initializeApp();
            }
        })();
    </script>
</body>
</html>
